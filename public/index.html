<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h1>Голосовалка</h1>
    <p>Кто царь зверей?</p>
    <form id="form" action="/" method="post">
        <select name="vote" id="variants"></select>

        <button type="submit">
            Отправить
        </button>
    </form>

    <p id="goodVoice" style="display: none;">Ваш голос принят!</p>

    <h1>Статистика</h1>

    <ul id="stat">

    </ul>
<script>
    window.onload = () => {
        const variantsContainer = document.querySelector('#variants')
        const statContainer = document.querySelector('#stat')
        const form = document.querySelector('#form')
        const goodVoice = document.querySelector('#goodVoice')

        async function fetchVariants () {
            const response = await fetch('/variants')
            if (response.ok) {
                let json = await response.json();
                for (let item in json) {
                    // Голосование
                    const currentItem = document.createElement('option')
                    currentItem.textContent = json[item].title
                    currentItem.value = item
                    variantsContainer.appendChild(currentItem)

                    // Статистика
                    const statItem = document.createElement('li')
                    statItem.textContent = json[item].title
                    statItem.textContent += ' ' + json[item].votes
                    statContainer.appendChild(statItem)
                }
            }
        }

        fetchVariants()

        form.addEventListener('submit', async e => {
            e.preventDefault()

            const url = '/stat';
            const data = { vote: variantsContainer.value };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(async () => {
                    const variants = await fetch('/variants')
                    if (variants.ok) {
                        statContainer.innerHTML = ''
                        let json = await variants.json();
                        for (let item in json) {
                            const statItem = document.createElement('li')
                            statItem.textContent = json[item].title
                            statItem.textContent += ' ' + json[item].votes
                            statContainer.appendChild(statItem)
                        }
                    }
                    goodVoice.style.display = 'block'
                    setTimeout(() => {
                        goodVoice.style.display = 'none'
                    }, 5000)
                })
            } catch (error) {
                console.error('Ошибка:', error);
            }
        })
    }
</script>
</body>
</html>
